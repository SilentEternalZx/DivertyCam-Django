{# templates/photobooth/configurar_photobooth.html #}
{% extends 'layout/layout.html' %}

{% block title %}Configurar Photobooth - {{ evento.nombre }}{% endblock %}

{% block content %}
<br>
<br>
<div class="card">
    <div class="card-header">
        <h2>Configurar Photobooth para "{{ evento.nombre }}"</h2>
        <p class="text-muted">Cliente: {{ evento.cliente.nombre }} {{ evento.cliente.apellido }}</p>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <form method="post" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    
                    <h4>Configuración de Bienvenida</h4>
                    <div class="mb-3">
                        <label for="{{ form.mensaje_bienvenida.id_for_label }}" class="form-label">Mensaje de bienvenida:</label>
                        {{ form.mensaje_bienvenida.errors }}
                        {{ form.mensaje_bienvenida }}
                        <div class="form-text">Este mensaje se mostrará en la pantalla de bienvenida del photobooth.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.imagen_fondo.id_for_label }}" class="form-label">Imagen de fondo:</label>
                        {{ form.imagen_fondo.errors }}
                        {{ form.imagen_fondo }}
                        <div class="form-text">Imagen de fondo para la pantalla de bienvenida.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.color_texto.id_for_label }}" class="form-label">Color del texto:</label>
                        {{ form.color_texto.errors }}
                        {{ form.color_texto }}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.tamano_texto.id_for_label }}" class="form-label">Tamaño del texto:</label>
                        {{ form.tamano_texto.errors }}
                        {{ form.tamano_texto }}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.tipo_letra.id_for_label }}" class="form-label">Tipo de letra:</label>
                        {{ form.tipo_letra.errors }}
                        {{ form.tipo_letra }}
                    </div>
                                                            
                    <div class="mb-3">
                        <label for="{{ form.plantilla_collage.id_for_label }}" class="form-label">Plantilla de collage:</label>
                        {{ form.plantilla_collage.errors }}
                        {{ form.plantilla_collage }}
                        <div class="form-text">Selecciona una plantilla personalizada para el collage o utiliza el modo estándar.</div>
                    </div>
                    
                    <div class="mb-3">
                        <a href="{% url 'template_list' evento.id %}" class="btn btn-outline-primary">
                            <i class="fas fa-th-large"></i> Gestionar plantillas
                        </a>
                        <a href="{% url 'template_editor' evento.id %}" class="btn btn-outline-success">
                            <i class="fas fa-plus"></i> Crear nueva plantilla
                        </a>
                    </div>
                                                            
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary">Guardar Configuración</button>
                        <a href="{% url 'preview_photobooth' evento.id %}" class="btn btn-success">Ver Vista Previa</a>
                        <a href="{% url 'evento_detail' evento.id %}" class="btn btn-secondary">Volver al Evento</a>
                    </div>
                </form>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h4>Vista previa de bienvenida</h4>
                    </div>
                    <div class="card-body">
                        <div id="preview" style="height: 600px; display: flex; justify-content: center; align-items: center; background-size: cover; background-position: center;">
                            <h1 id="previewMessage" style="padding: 20px; background-color: rgba(255, 255, 255, 0.7); border-radius: 10px;">
                                {{ config.mensaje_bienvenida|default:"¡Bienvenidos al photobooth!" }}
                            </h1>
                        </div>
                    </div>
                </div>
                
                <!-- Nueva sección para vista previa de collage -->
                <div class="card">
                    <div class="card-header">
                        <h4>Vista previa de collage</h4>
                    </div>
                    <div class="card-body text-center">
                        {% if selected_template %}
                            <div id="collage-preview" style="width: 600px; height: 400px; margin: 0 auto; position: relative; border: 1px solid #ddd; overflow: hidden; background-color: {{ selected_template.background_color|default:'white' }}">
                                {% if selected_template.background_image %}
                                    <img src="{{ selected_template.background_image.url }}" style="position: absolute; width: 100%; height: 100%; object-fit: cover;">
                                {% endif %}
                                
                                <!-- Marcos de fotos -->
                                {% for frame in frames %}
                                    <div class="photo-frame" style="position: absolute; width: {{ frame.width }}; height: {{ frame.height }}; left: {{ frame.left }}; top: {{ frame.top }}; border: 2px {{ frame.borderStyle|default:'dashed' }} #FF6B6B; background-color: rgba(255,107,107,0.2);"></div>
                                {% endfor %}
                            </div>
                            <p class="mt-2">{{ selected_template.nombre }}</p>
                            <p class="text-muted small">{{ selected_template.descripcion }}</p>
                        {% else %}
                            <div class="alert alert-info">
                                <p><i class="fas fa-info-circle"></i> No hay plantilla de collage seleccionada</p>
                                <p>Selecciona una plantilla existente o crea una nueva para personalizar la disposición de las fotos en el collage.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mensajeInput = document.getElementById('{{ form.mensaje_bienvenida.id_for_label }}');
        const colorInput = document.getElementById('{{ form.color_texto.id_for_label }}');
        const tamanoInput = document.getElementById('{{ form.tamano_texto.id_for_label }}');
        const tipoLetraInput = document.getElementById('{{ form.tipo_letra.id_for_label }}');
        const imagenInput = document.getElementById('{{ form.imagen_fondo.id_for_label }}');
        const plantillaSelect = document.getElementById('{{ form.plantilla_collage.id_for_label }}');
        
        const previewMessage = document.getElementById('previewMessage');
        const preview = document.getElementById('preview');
        
        // Inicializar con valores actuales
        {% if config and config.imagen_fondo %}
        preview.style.backgroundImage = "url('{{ config.imagen_fondo.url }}')";
        {% endif %}
        
        previewMessage.style.color = "{{ config.color_texto|default:'#000000' }}";
        previewMessage.style.fontSize = "{{ config.tamano_texto|default:'24' }}px";
        previewMessage.style.fontFamily = "{{ config.tipo_letra|default:'Arial' }}, sans-serif";
        
        // Actualizar vista previa al cambiar valores
        mensajeInput.addEventListener('input', function() {
            previewMessage.textContent = this.value;
        });
        
        colorInput.addEventListener('input', function() {
            previewMessage.style.color = this.value;
        });
        
        tamanoInput.addEventListener('input', function() {
            previewMessage.style.fontSize = this.value + 'px';
        });
        
        tipoLetraInput.addEventListener('change', function() {
            previewMessage.style.fontFamily = this.value + ', sans-serif';
        });
        
        imagenInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.style.backgroundImage = `url('${e.target.result}')`;
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Actualizar la vista previa del collage al cambiar la plantilla
        if (plantillaSelect) {
            plantillaSelect.addEventListener('change', function() {
                if (this.value) {
                    window.location.href = window.location.pathname + '?template=' + this.value;
                }
            });
        }
    });
</script>
{% endblock %}