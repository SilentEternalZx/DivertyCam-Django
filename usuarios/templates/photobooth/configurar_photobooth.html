
    {# templates/photobooth/configurar_photobooth.html - VERSIÓN MEJORADA #}
{% extends 'layout/layout.html' %}

{% block title %}Configurar Photobooth - {{ evento.nombre }}{% endblock %}

{% block extra_head %}
<style>
    /* Estilos personalizados para mejorar la apariencia */
    body {
        background-color: #f8f9fa;
    }
    
    .main-card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: none;
        border-radius: 0.5rem;
    }
    
    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.5rem 0.5rem 0 0 !important;
        padding: 1.5rem;
    }
    
    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
        background-color: #fff;
        border-radius: 0.5rem 0.5rem 0 0;
        padding: 0.5rem 1rem 0;
        margin: 0 -1.5rem;
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
        padding: 0.75rem 1.5rem;
        margin-bottom: -2px;
        border-radius: 0.5rem 0.5rem 0 0;
        transition: all 0.3s ease;
    }
    
    .nav-tabs .nav-link:hover {
        background-color: #f8f9fa;
        color: #495057;
    }
    
    .nav-tabs .nav-link.active {
        background-color: #fff;
        color: #667eea;
        border-bottom: 2px solid #667eea;
        font-weight: 600;
    }
    
    .tab-content {
        background-color: #fff;
        min-height: 500px;
        padding: 2rem !important;
    }
    
    .config-section {
        background: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 1.5rem;
        overflow: hidden;
    }
    
    .config-section .card-header {
        background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%);
        color: #495057;
        padding: 1rem 1.5rem;
        font-weight: 600;
        font-size: 1.1rem;
        border-bottom: 1px solid #dee2e6;
    }
    
    .config-section .card-body {
        padding: 1.5rem;
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .form-control, .form-select {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        padding: 0.75rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
    }
    
    .btn {
        font-weight: 500;
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 0.25rem 0.5rem rgba(102, 126, 234, 0.3);
    }
    
    .btn-outline-primary {
        border-color: #667eea;
        color: #667eea;
    }
    
    .btn-outline-primary:hover {
        background-color: #667eea;
        border-color: #667eea;
    }
    
    .preview-container {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 0.5rem;
        padding: 2rem;
        text-align: center;
        min-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .preview-container:hover {
        border-color: #667eea;
        background-color: #f8f9fb;
    }
    
    .camera-preview-container {
        background: #000;
        border-radius: 0.5rem;
        overflow: hidden;
        position: relative;
    }
    
    .alert {
        border: none;
        border-radius: 0.5rem;
        padding: 1rem 1.5rem;
    }
    
    .alert-info {
        background: linear-gradient(135deg, #d1ecf1 0%, #b8daff 100%);
        color: #0c5460;
    }
    
    .alert-success {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
    }
    
    .alert-warning {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        color: #856404;
    }
    
    .alert-danger {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        color: #721c24;
    }
    
    .range-slider {
        position: relative;
    }
    
    .range-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .camera-type-section {
        border-left: 4px solid #667eea;
        padding-left: 1rem;
        margin-left: 1rem;
    }
    
    .list-group-item {
        border: 1px solid #e9ecef;
        border-radius: 0.375rem !important;
        margin-bottom: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .status-indicator {
        display: inline-block;
        width: 0.75rem;
        height: 0.75rem;
        border-radius: 50%;
        margin-right: 0.5rem;
    }
    
    .status-connected {
        background-color: #28a745;
        box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.3);
    }
    
    .status-disconnected {
        background-color: #dc3545;
        box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.3);
    }
    
    .compact-row {
        margin-bottom: 1rem;
    }
    
    .compact-row .col-md-6 {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
    }
    
    .form-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .sticky-footer {
        position: sticky;
        bottom: 0;
        background: #fff;
        border-top: 1px solid #dee2e6;
        padding: 1.5rem;
        margin: 0 -1.5rem -1.5rem;
        border-radius: 0 0 0.5rem 0.5rem;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
        .nav-tabs {
            padding: 0.25rem 0.5rem 0;
        }
        
        .nav-tabs .nav-link {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .tab-content {
            padding: 1rem !important;
        }
        
        .config-section .card-body {
            padding: 1rem;
        }
        
        .compact-row .col-md-6 {
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card main-card">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Configurar Photobooth
                    </h2>
                    <p class="mb-0 mt-2 opacity-75">
                        <strong>{{ evento.nombre }}</strong> • {{ evento.cliente.nombre }} {{ evento.cliente.apellido }}
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex gap-2 justify-content-end">
                        <a href="{% url 'preview_photobooth' evento.id %}" class="btn btn-light btn-sm">
                            <i class="fas fa-eye"></i> Vista Previa
                        </a>
                        <a href="{% url 'evento_detail' evento.id %}" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-arrow-left"></i> Volver
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <form method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            
            <div class="card-body p-0">
                <ul class="nav nav-tabs" id="configTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button">
                            <i class="fas fa-home"></i> General
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="plantilla-tab" data-bs-toggle="tab" data-bs-target="#plantilla" type="button">
                            <i class="fas fa-th-large"></i> Plantilla
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="camara-tab" data-bs-toggle="tab" data-bs-target="#camara" type="button">
                            <i class="fas fa-camera"></i> Cámara
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tiempos-tab" data-bs-toggle="tab" data-bs-target="#tiempos" type="button">
                            <i class="fas fa-clock"></i> Tiempos
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="impresora-tab" data-bs-toggle="tab" data-bs-target="#impresora" type="button">
                            <i class="fas fa-print"></i> Impresora
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button">
                            <i class="fas fa-eye"></i> Vista Previa
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="configTabsContent">
                    <!-- ========== PESTAÑA GENERAL ========== -->
                    <div class="tab-pane fade show active" id="general" role="tabpanel">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="config-section">
                                    <div class="card-header">
                                        <i class="fas fa-comment-dots me-2"></i>Mensaje de Bienvenida
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="{{ form.mensaje_bienvenida.id_for_label }}" class="form-label">
                                                Mensaje principal
                                            </label>
                                            {{ form.mensaje_bienvenida.errors }}
                                            {{ form.mensaje_bienvenida }}
                                            <div class="form-text">Este mensaje aparecerá en la pantalla inicial del photobooth</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="{{ form.imagen_fondo.id_for_label }}" class="form-label">
                                                Imagen de fondo
                                            </label>
                                            {{ form.imagen_fondo.errors }}
                                            {{ form.imagen_fondo }}
                                            <div class="form-text">Imagen para el fondo de la pantalla de bienvenida</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-6">
                                <div class="config-section">
                                    <div class="card-header">
                                        <i class="fas fa-palette me-2"></i>Estilo de Texto
                                    </div>
                                    <div class="card-body">
                                        <div class="compact-row row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="{{ form.color_texto.id_for_label }}" class="form-label">
                                                        Color del texto
                                                    </label>
                                                    {{ form.color_texto.errors }}
                                                    {{ form.color_texto }}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="{{ form.tamano_texto.id_for_label }}" class="form-label">
                                                        Tamaño (px)
                                                    </label>
                                                    {{ form.tamano_texto.errors }}
                                                    {{ form.tamano_texto }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="{{ form.tipo_letra.id_for_label }}" class="form-label">
                                                Tipo de letra
                                            </label>
                                            {{ form.tipo_letra.errors }}
                                            {{ form.tipo_letra }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ========== PESTAÑA PLANTILLA ========== -->
                    <div class="tab-pane fade" id="plantilla" role="tabpanel">
                        <div class="row">
                            <div class="col-lg-5">
                                <div class="config-section">
                                    <div class="card-header">
                                        <i class="fas fa-th-large me-2"></i>Selección de Plantilla
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="{{ form.plantilla_collage.id_for_label }}" class="form-label">
                                                Plantilla de collage
                                            </label>
                                            {{ form.plantilla_collage.errors }}
                                            {{ form.plantilla_collage }}
                                            <div class="form-text">Selecciona la distribución de fotos para el collage</div>
                                        </div>
                                        
                                        <div class="d-grid gap-2">
                                            <a href="{% url 'template_list' evento.id %}" class="btn btn-outline-primary">
                                                <i class="fas fa-list me-2"></i>Gestionar plantillas
                                            </a>
                                            <a href="{% url 'template_editor' evento.id %}" class="btn btn-primary">
                                                <i class="fas fa-plus me-2"></i>Crear nueva plantilla
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-7">
                                <div class="config-section">
                                    <div class="card-header">
                                        <i class="fas fa-eye me-2"></i>Vista Previa de la Plantilla
                                    </div>
                                    <div class="card-body">
                                        {% if selected_template %}
                                        <div class="preview-container">
                                            <div id="collage-preview" style="width: 100%; max-width: 500px; height: 320px; position: relative; border: 1px solid #ddd; overflow: hidden; background-color: {{ selected_template.background_color|default:'white' }};">
                                                {% if selected_template.background_image %}
                                                    <img src="{{ selected_template.background_image.url }}" style="position: absolute; width: 100%; height: 100%; object-fit: cover;">
                                                {% endif %}
                                                
                                                {% for frame in frames %}
                                                    <div class="photo-frame" style="position: absolute; width: {{ frame.width }}; height: {{ frame.height }}; left: {{ frame.left }}; top: {{ frame.top }}; border: 2px {{ frame.borderStyle|default:'dashed' }} #667eea; background-color: rgba(102, 126, 234, 0.1); display: flex; align-items: center; justify-content: center; color: #667eea; font-weight: bold; font-size: 0.8rem;">
                                                        Foto {{ forloop.counter }}
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="text-center mt-3">
                                            <h6 class="mb-1">{{ selected_template.nombre }}</h6>
                                            <p class="text-muted small mb-0">{{ selected_template.descripcion }}</p>
                                        </div>
                                        {% else %}
                                        <div class="preview-container">
                                            <div class="text-center">
                                                <i class="fas fa-image fa-3x text-muted mb-3"></i>
                                                <h5 class="text-muted">Sin plantilla seleccionada</h5>
                                                <p class="text-muted">Selecciona una plantilla para ver la vista previa</p>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ========== PESTAÑA CÁMARA ========== -->
                    <div class="tab-pane fade" id="camara" role="tabpanel">
                        <div class="row">
                            <!-- Panel izquierdo: Configuración -->
                            <div class="col-lg-6">
                                <div class="config-section">
                                    <div class="card-header">
                                        <i class="fas fa-camera me-2"></i>Configuración de Cámara
                                    </div>
                                    <div class="card-body">
                                        <div id="camera-alert" class="alert alert-info" style="display: none;"></div>
                                        
                                        <!-- Selector de tipo de cámara -->
                                        <div class="mb-4">
                                            <label for="tipo-camara" class="form-label">Tipo de cámara</label>
                                            <select id="tipo-camara" name="tipo_camara" class="form-select">
                                                <option value="webcam">Cámara Web</option>
                                                <option value="windows_camera">Cámara Windows (WIA/PTP)</option>
                                                <option value="usb_ptp">Cámara USB (PTP Directo)</option>
                                                <option value="nikon_dslr">Cámara Nikon DSLR</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Sección para Cámara Web -->
                                        <div id="webcam-section" class="camera-type-section">
                                            <h6 class="mb-3"><i class="fas fa-video me-2"></i>Configuración Webcam</h6>
                                            
                                            <div class="compact-row row">
                                                <div class="col-md-8">
                                                    <div class="mb-3">
                                                        <label for="camera-select" class="form-label">Seleccionar cámara</label>
                                                        <select id="camera-select" class="form-select">
                                                            <option value="" disabled selected>Detectando cámaras...</option>
                                                        </select>
                                                        <input type="hidden" id="selected-camera-id" name="camera_id" value="{{ config.camera_id }}">
                                                        <input type="hidden" id="hidden_usb_connection_timeout" name="usb_connection_timeout" value="10">
                                                        <input type="hidden" id="hidden_usb_capture_timeout" name="usb_capture_timeout" value="30">
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="mb-3">
                                                        <label class="form-label">&nbsp;</label>
                                                        <button type="button" id="refresh-cameras-btn" class="btn btn-outline-secondary d-block w-100">
                                                            <i class="fas fa-sync-alt"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="{{ form.resolucion_camara.id_for_label }}" class="form-label">Resolución</label>
                                                {{ form.resolucion_camara.errors }}
                                                {{ form.resolucion_camara }}
                                            </div>
                                        </div>
                                        
                                        <!-- Configuración común -->
                                        <div class="mt-4">
                                            <h6 class="mb-3"><i class="fas fa-sliders-h me-2"></i>Ajustes de Imagen</h6>
                                            
                                            <div class="compact-row row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="{{ form.nivel_iluminacion.id_for_label }}" class="form-label">
                                                            Iluminación: <span id="iluminacion-value">{{ config.nivel_iluminacion|default:50 }}%</span>
                                                        </label>
                                                        {{ form.nivel_iluminacion.errors }}
                                                        {{ form.nivel_iluminacion }}
                                                        <div class="range-labels">
                                                            <small>Oscuro</small>
                                                            <small>Normal</small>
                                                            <small>Brillante</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="{{ form.iso_valor.id_for_label }}" class="form-label">ISO</label>
                                                        {{ form.iso_valor.errors }}
                                                        {{ form.iso_valor }}
                                                        <div class="form-text">Para condiciones de poca luz</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="compact-row row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="{{ form.calidad_imagen.id_for_label }}" class="form-label">Calidad</label>
                                                        {{ form.calidad_imagen.errors }}
                                                        {{ form.calidad_imagen }}
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="{{ form.modo_enfoque.id_for_label }}" class="form-label">Enfoque</label>
                                                        {{ form.modo_enfoque.errors }}
                                                        {{ form.modo_enfoque }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Panel derecho: Vista previa -->
                            <div class="col-lg-6">
                                <div class="config-section">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-eye me-2"></i>Vista Previa</span>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" id="start-preview-btn" class="btn btn-success">
                                                <i class="fas fa-play"></i>
                                            </button>
                                            <button type="button" id="stop-preview-btn" class="btn btn-danger" disabled>
                                                <i class="fas fa-stop"></i>
                                            </button>
                                            <button type="button" id="capture-test-btn" class="btn btn-primary" disabled>
                                                <i class="fas fa-camera"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="camera-preview-container" class="camera-preview-container" style="width: 100%; height: 350px;">
                                            <video id="camera-preview" style="width: 100%; height: 100%; object-fit: cover; display: none;" autoplay playsinline></video>
                                            
                                            <div id="no-camera-message" class="d-flex justify-content-center align-items-center h-100 text-light">
                                                <div class="text-center">
                                                    <i class="fas fa-camera fa-3x mb-3 opacity-50"></i>
                                                    <p class="mb-0 opacity-75">Selecciona una cámara para iniciar</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Vista previa de imagen capturada -->
                                <div class="config-section mt-3" id="captured-image-preview" style="display: none;">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-image me-2"></i>Imagen de Prueba</span>
                                        <button type="button" class="btn-close btn-close-white" onclick="document.getElementById('captured-image-preview').style.display='none'"></button>
                                    </div>
                                    <div class="card-body p-0">
                                        <img id="test-image" src="" alt="Imagen de prueba" class="img-fluid">
                                    </div>
                                    <div class="card-body">
                                        <small id="capture-info" class="text-muted"></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ========== PESTAÑA TIEMPOS ========== -->
                    <div class="tab-pane fade" id="tiempos" role="tabpanel">
                        <div class="row justify-content-center">
                            <div class="col-lg-8">
                                <div class="config-section">
                                    <div class="card-header">
                                        <i class="fas fa-clock me-2"></i>Configuración de Tiempos
                                    </div>
                                    <div class="card-body">
                                        <div class="compact-row row">
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="{{ form.tiempo_cuenta_regresiva.id_for_label }}" class="form-label">
                                                        Cuenta regresiva
                                                    </label>
                                                    {{ form.tiempo_cuenta_regresiva.errors }}
                                                    {{ form.tiempo_cuenta_regresiva }}
                                                    <div class="form-text">Antes de cada foto (1-10 seg)</div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="{{ form.tiempo_entre_fotos.id_for_label }}" class="form-label">
                                                        Entre fotos
                                                    </label>
                                                    {{ form.tiempo_entre_fotos.errors }}
                                                    {{ form.tiempo_entre_fotos }}
                                                    <div class="form-text">Intervalo entre fotos (1-20 seg)</div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="{{ form.tiempo_visualizacion_foto.id_for_label }}" class="form-label">
                                                        Visualización
                                                    </label>
                                                    {{ form.tiempo_visualizacion_foto.errors }}
                                                    {{ form.tiempo_visualizacion_foto }}
                                                    <div class="form-text">Tiempo de muestra (1-10 seg)</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Simulador visual de tiempos -->
                                        <div class="mt-4 p-3 bg-light rounded">
                                            <h6 class="mb-3"><i class="fas fa-play-circle me-2"></i>Simulación del Proceso</h6>
                                            <div class="d-flex align-items-center justify-content-between">
                                                <div class="text-center">
                                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 50px; height: 50px;">
                                                        <i class="fas fa-hourglass-start"></i>
                                                    </div>
                                                    <small>Cuenta regresiva</small>
                                                    <div class="fw-bold" id="countdown-preview">3s</div>
                                                </div>
                                                <div class="text-center">
                                                    <i class="fas fa-arrow-right text-muted"></i>
                                                </div>
                                                <div class="text-center">
                                                    <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 50px; height: 50px;">
                                                        <i class="fas fa-camera"></i>
                                                    </div>
                                                    <small>Captura</small>
                                                    <div class="fw-bold">Click!</div>
                                                </div>
                                                <div class="text-center">
                                                    <i class="fas fa-arrow-right text-muted"></i>
                                                </div>
                                                <div class="text-center">
                                                    <div class="rounded-circle bg-info text-white d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 50px; height: 50px;">
                                                        <i class="fas fa-eye"></i>
                                                    </div>
                                                    <small>Visualización</small>
                                                    <div class="fw-bold" id="preview-time">2s</div>
                                                </div>
                                                <div class="text-center">
                                                    <i class="fas fa-arrow-right text-muted"></i>
                                                </div>
                                                <div class="text-center">
                                                    <div class="rounded-circle bg-warning text-white d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 50px; height: 50px;">
                                                        <i class="fas fa-clock"></i>
                                                    </div>
                                                    <small>Pausa</small>
                                                    <div class="fw-bold" id="between-photos-time">3s</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ========== PESTAÑA IMPRESORA ========== -->
                    <div class="tab-pane fade" id="impresora" role="tabpanel">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="config-section">
                                    <div class="card-header">
                                        <i class="fas fa-print me-2"></i>Configuración de Impresora
                                    </div>
                                    <div class="card-body">
                                        <div id="printer-alert" class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> Conecta una impresora para seleccionarla
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="printer-select" class="form-label">Impresora</label>
                                            <div class="input-group">
                                                <select id="printer-select" class="form-select" name="printer_name">
                                                    <option value="" selected>-- Seleccionar impresora --</option>
                                                    {% for printer in printers %}
                                                    <option value="{{ printer }}" {% if printer == config.printer_name %}selected{% endif %}>
                                                        {{ printer }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                                <button type="button" id="refresh-printers-btn" class="btn btn-outline-secondary">
                                                    <i class="fas fa-sync-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="compact-row row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="{{ form.paper_size.id_for_label }}" class="form-label">Tamaño de papel</label>
                                                    {{ form.paper_size.errors }}
                                                    {{ form.paper_size }}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="{{ form.copias_impresion.id_for_label }}" class="form-label">Copias</label>
                                                    {{ form.copias_impresion.errors }}
                                                    {{ form.copias_impresion }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="{{ form.calidad_impresion.id_for_label }}" class="form-label">Calidad</label>
                                            {{ form.calidad_impresion.errors }}
                                            {{ form.calidad_impresion }}
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            {{ form.imprimir_automaticamente }}
                                            <label class="form-check-label" for="{{ form.imprimir_automaticamente.id_for_label }}">
                                                <strong>Impresión automática</strong>
                                            </label>
                                            <div class="form-text">Los collages se imprimirán automáticamente al finalizar</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-6">
                                <div class="config-section">
                                    <div class="card-header">
                                        <i class="fas fa-vial me-2"></i>Prueba de Impresión
                                    </div>
                                    <div class="card-body">
                                        <div class="text-center mb-4">
                                            <i class="fas fa-print fa-3x text-muted mb-3"></i>
                                            <p class="mb-3">Realiza una prueba con la configuración actual</p>
                                            <button type="button" id="test-print-btn" class="btn btn-primary">
                                                <i class="fas fa-print me-2"></i>Imprimir página de prueba
                                            </button>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <h6 class="mb-3">Estado de la Impresora</h6>
                                            <div id="printer-status" class="alert alert-secondary">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-circle-notch fa-spin me-2"></i>
                                                    <span>Verificando estado...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ========== PESTAÑA VISTA PREVIA ========== -->
                    <div class="tab-pane fade" id="preview" role="tabpanel">
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="config-section">
                                    <div class="card-header">
                                        <i class="fas fa-desktop me-2"></i>Pantalla de Bienvenida
                                    </div>
                                    <div class="card-body">
                                        <div id="preview-welcome" style="height: 300px; display: flex; justify-content: center; align-items: center; background-size: cover; background-position: center; background-repeat: no-repeat; border-radius: 0.5rem; border: 1px solid #dee2e6;">
                                            <h1 id="preview-message" style="padding: 20px; background-color: rgba(255, 255, 255, 0.9); border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); text-align: center;">
                                                {{ config.mensaje_bienvenida|default:"¡Bienvenidos al photobooth!" }}
                                            </h1>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="config-section">
                                    <div class="card-header">
                                        <i class="fas fa-th-large me-2"></i>Plantilla de Collage
                                    </div>
                                    <div class="card-body">
                                        {% if selected_template %}
                                        <div class="text-center">
                                            <div class="d-inline-block">
                                                <div id="collage-preview-full" style="width: 600px; height: 400px; position: relative; border: 2px solid #667eea; border-radius: 0.5rem; overflow: hidden; background-color: {{ selected_template.background_color|default:'white' }}; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                                                    {% if selected_template.background_image %}
                                                        <img src="{{ selected_template.background_image.url }}" style="position: absolute; width: 100%; height: 100%; object-fit: cover;">
                                                    {% endif %}
                                                    
                                                    {% for frame in frames %}
                                                        <div class="photo-frame" style="position: absolute; width: {{ frame.width }}; height: {{ frame.height }}; left: {{ frame.left }}; top: {{ frame.top }}; border: 2px {{ frame.borderStyle|default:'dashed' }} #667eea; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); display: flex; align-items: center; justify-content: center; color: #667eea; font-weight: bold; font-size: 1rem; backdrop-filter: blur(2px);">
                                                            <span style="background: rgba(255,255,255,0.9); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Foto {{ forloop.counter }}</span>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <h5 class="mb-1">{{ selected_template.nombre }}</h5>
                                                <p class="text-muted">{{ selected_template.descripcion }}</p>
                                                <div class="d-flex justify-content-center gap-2 mt-3">
                                                    <span class="badge bg-primary">{{ frames|length }} fotos</span>
                                                    <span class="badge bg-info">{{ selected_template.background_color|default:'Fondo blanco' }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="text-center py-5">
                                            <i class="fas fa-image fa-4x text-muted mb-4"></i>
                                            <h4 class="text-muted mb-3">Sin plantilla seleccionada</h4>
                                            <p class="text-muted mb-4">Selecciona una plantilla en la pestaña "Plantilla" para ver la vista previa completa</p>
                                            <a href="#plantilla-tab" class="btn btn-primary" data-bs-toggle="tab">
                                                <i class="fas fa-th-large me-2"></i>Ir a Plantillas
                                            </a>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer fijo con botones de acción -->
            <div class="sticky-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save me-2"></i>Guardar Configuración
                        </button>
                        <a href="{% url 'preview_photobooth' evento.id %}" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-eye me-2"></i>Vista Previa Completa
                        </a>
                        <button type="button" class="btn btn-outline-secondary" onclick="debugFormData()">
                            <i class="fas fa-bug me-2"></i>Debug
                        </button>
                    </div>
                    <div>
                        <a href="{% url 'evento_detail' evento.id %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Volver al Evento
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// JavaScript mejorado y optimizado
document.addEventListener('DOMContentLoaded', function() {
    console.log('Iniciando configuración de photobooth...');
    
    // ========== VARIABLES GLOBALES ==========
    let currentCameraType = 'webcam';
    let mediaStream = null;
    let previewActive = false;
    let availableCameras = [];
    
    // ========== ELEMENTOS DOM ==========
    const tipoCamaraSelect = document.getElementById('tipo-camara');
    const webcamSection = document.getElementById('webcam-section');
    const cameraAlert = document.getElementById('camera-alert');
    const cameraSelect = document.getElementById('camera-select');
    const refreshCamerasBtn = document.getElementById('refresh-cameras-btn');
    const selectedCameraIdInput = document.getElementById('selected-camera-id');
    const videoPreview = document.getElementById('camera-preview');
    const noCameraMessage = document.getElementById('no-camera-message');
    const startPreviewBtn = document.getElementById('start-preview-btn');
    const stopPreviewBtn = document.getElementById('stop-preview-btn');
    const captureTestBtn = document.getElementById('capture-test-btn');
    const capturedImagePreview = document.getElementById('captured-image-preview');
    const testImage = document.getElementById('test-image');
    
    // Elementos de tiempos para simulación
    const countdownInput = document.getElementById('{{ form.tiempo_cuenta_regresiva.id_for_label }}');
    const betweenPhotosInput = document.getElementById('{{ form.tiempo_entre_fotos.id_for_label }}');
    const previewTimeInput = document.getElementById('{{ form.tiempo_visualizacion_foto.id_for_label }}');
    
    // ========== FUNCIONES UTILITARIAS ==========
    function showAlert(element, message, type = 'info') {
        if (element) {
            element.className = `alert alert-${type}`;
            element.innerHTML = message;
            element.style.display = 'block';
            
            setTimeout(() => {
                if (element && element.style.display !== 'none') {
                    element.style.opacity = '0.7';
                }
            }, 3000);
        }
    }
    
    function hideAlert(element) {
        if (element) {
            element.style.display = 'none';
        }
    }
    
    // ========== FUNCIONES DE CÁMARA ==========
    async function listAvailableCameras() {
        console.log('Detectando cámaras...');
        
        try {
            // Solicitar permisos primero
            const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
            tempStream.getTracks().forEach(track => track.stop());
            
            // Enumerar dispositivos
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            availableCameras = videoDevices;
            
            console.log('Cámaras encontradas:', videoDevices.length);
            
            if (cameraSelect) {
                cameraSelect.innerHTML = '<option value="" disabled>Seleccionar cámara...</option>';
                
                if (videoDevices.length === 0) {
                    cameraSelect.innerHTML = '<option value="" disabled>No se detectaron cámaras</option>';
                    showAlert(cameraAlert, '<i class="fas fa-exclamation-triangle"></i> No se detectaron cámaras web', 'warning');
                } else {
                    videoDevices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.text = device.label || `Cámara ${index + 1}`;
                        cameraSelect.appendChild(option);
                    });
                    
                    hideAlert(cameraAlert);
                    
                    // Seleccionar automáticamente si hay solo una
                    if (videoDevices.length === 1) {
                        cameraSelect.value = videoDevices[0].deviceId;
                        if (selectedCameraIdInput) {
                            selectedCameraIdInput.value = videoDevices[0].deviceId;
                        }
                    }
                    
                    // Restaurar selección guardada
                    const savedCameraId = selectedCameraIdInput ? selectedCameraIdInput.value : null;
                    if (savedCameraId && videoDevices.some(device => device.deviceId === savedCameraId)) {
                        cameraSelect.value = savedCameraId;
                    }
                }
            }
            
            return videoDevices.length > 0;
            
        } catch (error) {
            console.error('Error al enumerar cámaras:', error);
            
            let errorType = 'danger';
            let errorMessage = '';
            
            if (error.name === 'NotAllowedError') {
                errorMessage = '<i class="fas fa-shield-alt"></i> Permiso denegado. Permite el acceso a la cámara para continuar.';
            } else if (error.name === 'NotFoundError') {
                errorMessage = '<i class="fas fa-search"></i> No se encontraron cámaras en el sistema.';
                errorType = 'warning';
            } else {
                errorMessage = '<i class="fas fa-exclamation-triangle"></i> Error al acceder a las cámaras: ' + error.message;
            }
            
            showAlert(cameraAlert, errorMessage, errorType);
            return false;
        }
    }
    
    async function startCameraPreview() {
        console.log('Iniciando vista previa...');
        
        try {
            // Detener stream anterior
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            const deviceId = cameraSelect ? cameraSelect.value : null;
            
            if (!deviceId) {
                showAlert(cameraAlert, '<i class="fas fa-hand-pointer"></i> Selecciona una cámara primero', 'warning');
                return false;
            }
            
            // Actualizar campo oculto
            if (selectedCameraIdInput) {
                selectedCameraIdInput.value = deviceId;
            }
            
            // Configurar stream
            const constraints = {
                video: {
                    deviceId: { exact: deviceId },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            };
            
            mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
            
            if (videoPreview) {
                videoPreview.srcObject = mediaStream;
                videoPreview.style.display = 'block';
                if (noCameraMessage) noCameraMessage.style.display = 'none';
            }
            
            // Actualizar botones
            if (startPreviewBtn) startPreviewBtn.disabled = true;
            if (stopPreviewBtn) stopPreviewBtn.disabled = false;
            if (captureTestBtn) captureTestBtn.disabled = false;
            
            previewActive = true;
            showAlert(cameraAlert, '<i class="fas fa-check-circle"></i> Vista previa iniciada correctamente', 'success');
            
            return true;
            
        } catch (error) {
            console.error('Error al iniciar vista previa:', error);
            showAlert(cameraAlert, `<i class="fas fa-exclamation-triangle"></i> Error: ${error.message}`, 'danger');
            return false;
        }
    }
    
    function stopCameraPreview() {
        console.log('Deteniendo vista previa...');
        
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
            mediaStream = null;
        }
        
        if (videoPreview) {
            videoPreview.srcObject = null;
            videoPreview.style.display = 'none';
        }
        
        if (noCameraMessage) noCameraMessage.style.display = 'flex';
        
        // Actualizar botones
        if (startPreviewBtn) startPreviewBtn.disabled = false;
        if (stopPreviewBtn) stopPreviewBtn.disabled = true;
        if (captureTestBtn) captureTestBtn.disabled = true;
        
        previewActive = false;
        hideAlert(cameraAlert);
    }
    
    function captureTestImage() {
        if (!mediaStream || !videoPreview) {
            showAlert(cameraAlert, '<i class="fas fa-exclamation-triangle"></i> La vista previa no está activa', 'warning');
            return;
        }
        
        try {
            const canvas = document.createElement('canvas');
            canvas.width = videoPreview.videoWidth;
            canvas.height = videoPreview.videoHeight;
            
            const context = canvas.getContext('2d');
            context.drawImage(videoPreview, 0, 0, canvas.width, canvas.height);
            
            const imageUrl = canvas.toDataURL('image/jpeg', 0.95);
            
            if (testImage && capturedImagePreview) {
                testImage.src = imageUrl;
                capturedImagePreview.style.display = 'block';
                
                const captureInfo = document.getElementById('capture-info');
                if (captureInfo) {
                    captureInfo.textContent = `Capturada - ${new Date().toLocaleString()} - ${canvas.width}x${canvas.height}px`;
                }
            }
            
            showAlert(cameraAlert, '<i class="fas fa-camera"></i> Imagen capturada exitosamente', 'success');
            
        } catch (error) {
            console.error('Error al capturar:', error);
            showAlert(cameraAlert, '<i class="fas fa-exclamation-triangle"></i> Error al capturar: ' + error.message, 'danger');
        }
    }
    
    // ========== FUNCIONES DE SIMULACIÓN DE TIEMPOS ==========
    function updateTimeSimulation() {
        const countdownTime = countdownInput ? countdownInput.value || 3 : 3;
        const previewTime = previewTimeInput ? previewTimeInput.value || 2 : 2;
        const betweenTime = betweenPhotosInput ? betweenPhotosInput.value || 3 : 3;
        
        const countdownPreview = document.getElementById('countdown-preview');
        const previewTimeElement = document.getElementById('preview-time');
        const betweenPhotosTime = document.getElementById('between-photos-time');
        
        if (countdownPreview) countdownPreview.textContent = countdownTime + 's';
        if (previewTimeElement) previewTimeElement.textContent = previewTime + 's';
        if (betweenPhotosTime) betweenPhotosTime.textContent = betweenTime + 's';
    }
    
    // ========== FUNCIONES DE VISTA PREVIA ==========
    function updateWelcomePreview() {
        const messageInput = document.getElementById('{{ form.mensaje_bienvenida.id_for_label }}');
        const colorInput = document.getElementById('{{ form.color_texto.id_for_label }}');
        const sizeInput = document.getElementById('{{ form.tamano_texto.id_for_label }}');
        const fontInput = document.getElementById('{{ form.tipo_letra.id_for_label }}');
        
        const previewMessage = document.getElementById('preview-message');
        
        if (previewMessage) {
            if (messageInput) previewMessage.textContent = messageInput.value || '¡Bienvenidos al photobooth!';
            if (colorInput) previewMessage.style.color = colorInput.value || '#000000';
            if (sizeInput) previewMessage.style.fontSize = (sizeInput.value || 24) + 'px';
            if (fontInput) previewMessage.style.fontFamily = fontInput.value || 'Arial, sans-serif';
        }
    }
    
    // ========== EVENT LISTENERS ==========
    
    // Selector de cámara
    if (cameraSelect) {
        cameraSelect.addEventListener('change', function() {
            if (selectedCameraIdInput) {
                selectedCameraIdInput.value = this.value;
            }
        });
    }
    
    // Botones de cámara
    if (refreshCamerasBtn) {
        refreshCamerasBtn.addEventListener('click', listAvailableCameras);
    }
    
    if (startPreviewBtn) {
        startPreviewBtn.addEventListener('click', startCameraPreview);
    }
    
    if (stopPreviewBtn) {
        stopPreviewBtn.addEventListener('click', stopCameraPreview);
    }
    
    if (captureTestBtn) {
        captureTestBtn.addEventListener('click', captureTestImage);
    }
    
    // Inputs de tiempo para simulación
    [countdownInput, betweenPhotosInput, previewTimeInput].forEach(input => {
        if (input) {
            input.addEventListener('input', updateTimeSimulation);
        }
    });
    
    // Inputs de vista previa de mensaje
    const previewInputs = [
        document.getElementById('{{ form.mensaje_bienvenida.id_for_label }}'),
        document.getElementById('{{ form.color_texto.id_for_label }}'),
        document.getElementById('{{ form.tamano_texto.id_for_label }}'),
        document.getElementById('{{ form.tipo_letra.id_for_label }}')
    ];
    
    previewInputs.forEach(input => {
        if (input) {
            input.addEventListener('input', updateWelcomePreview);
        }
    });
    
    // Slider de iluminación
    const iluminacionSlider = document.getElementById('{{ form.nivel_iluminacion.id_for_label }}');
    const iluminacionValue = document.getElementById('iluminacion-value');
    
    if (iluminacionSlider && iluminacionValue) {
        iluminacionSlider.addEventListener('input', function() {
            iluminacionValue.textContent = this.value + '%';
        });
    }
    
    // Limpiar recursos al salir
    window.addEventListener('beforeunload', function() {
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
        }
    });
    
    // ========== INICIALIZACIÓN ==========
    console.log('Inicializando interfaz...');
    
    // Detectar cámaras al cargar
    setTimeout(() => {
        if (currentCameraType === 'webcam') {
            listAvailableCameras();
        }
    }, 500);
    
    // Configurar simulaciones iniciales
    updateTimeSimulation();
    updateWelcomePreview();
    
    console.log('Configuración de photobooth lista');
});
</script>
{% endblock %}